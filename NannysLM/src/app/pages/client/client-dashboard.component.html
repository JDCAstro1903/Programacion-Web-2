
<div class="client-layout">
  <!-- Header Gen√©rico -->
  <app-header 
    [config]="headerConfig"
    [notifications]="notifications"
    (onLogout)="onHeaderLogout()"
    (onProfileClick)="onHeaderProfileClick()"
    (onNotificationClick)="handleNotificationClick($event)"
    (onMarkAllAsRead)="markAllNotificationsAsRead()">
  </app-header>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Sidebar Reutilizable -->
    <app-sidebar 
      [config]="sidebarConfig" 
      [currentView]="currentView"
      (onViewChange)="onViewChange($event)">
    </app-sidebar>

    <!-- Contenido principal -->
    <main class="main-content">

      <!-- Overlay/aviso para cuentas no verificadas: bloquea el acceso al dashboard
           y obliga a completar/mostrar la vista 'Informaci√≥n del Cliente' -->
      <div *ngIf="!profileData?.is_verified && verificationBlockerVisible" class="verification-blocker">
        <div class="verification-card">
          <h3>Tu cuenta est√° en revisi√≥n</h3>
          <p>Por seguridad, solo puedes completar tu informaci√≥n y subir los documentos solicitados.
             Una vez que tu cuenta sea verificada, tendr√°s acceso completo al panel.</p>
          <div class="verification-actions">
            <button class="confirm-btn" (click)="currentView = 'client-info'">Completar mi informaci√≥n</button>
            <!-- El bot√≥n de cerrar solo aparece si el usuario ya est√° en la vista de informaci√≥n -->
            <button *ngIf="currentView === 'client-info'" class="cancel-btn" (click)="closeVerificationOverlay()">Cerrar</button>
          </div>
          <small class="hint">Si ya subiste tus documentos, espera a que el equipo revise tu perfil. Revisa tu correo para notificaciones.</small>
        </div>
      </div>
      <!-- Vista Inicio -->
      <div *ngIf="currentView === 'dashboard'" class="dashboard-home">
        <div class="content-header">
          <h2>¬°Bienvenido de vuelta, {{ currentUser.name }}!</h2>
          <p>Resumen de tu actividad y servicios</p>
        </div>
        
        <!-- Tarjeta de bienvenida principal -->
        <div class="welcome-hero-card">
          <div class="hero-content">
            <div class="hero-text">
              <h3>Tu cuidado infantil profesional</h3>
              <p>Accede a cuidadoras verificadas y gestiona tus servicios de manera f√°cil y segura.</p>
              <div class="hero-actions">
                <button class="primary-action-btn" (click)="currentView = 'services'">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                  </svg>
                  Reservar Servicio
                </button>
                <button class="secondary-action-btn" (click)="currentView = 'contracted-services'">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                  </svg>
                  Ver Historial
                </button>
              </div>
            </div>
            <div class="hero-illustration">
              <div class="floating-card">
                <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M20 7h-9" stroke="#E31B7E" stroke-width="2" stroke-linecap="round"/>
                  <path d="M14 17H5" stroke="#E31B7E" stroke-width="2" stroke-linecap="round"/>
                  <circle cx="17" cy="17" r="3" stroke="#E31B7E" stroke-width="2"/>
                  <circle cx="7" cy="7" r="3" stroke="#E31B7E" stroke-width="2"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Grid de resumen r√°pido -->
        <div class="dashboard-overview-grid">
          <!-- Estado de la cuenta -->
          <div class="overview-card account-status">
            <div class="card-header">
              <div class="card-icon" [class.verified]="clientInfo?.is_verified" [class.unverified]="!clientInfo?.is_verified">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
              </div>
              <div class="card-title">
                <h4>Estado de Cuenta</h4>
                <p>{{ getVerificationStatusText() }}</p>
              </div>
            </div>
            <div class="card-content">
              <div class="status-badge-large" [class.verified]="clientInfo?.is_verified" [class.unverified]="!clientInfo?.is_verified">
                <span class="status-dot"></span>
                <span class="status-text">{{ clientInfo?.is_verified ? 'Cuenta Verificada' : 'Verificaci√≥n Pendiente' }}</span>
              </div>
              <p class="status-description">
                {{ clientInfo?.is_verified 
                  ? 'Tu cuenta est√° completamente verificada y lista para usar todos los servicios.' 
                  : 'Completa tu verificaci√≥n para acceder a todos los servicios.' }}
              </p>
            </div>
          </div>

          <!-- Servicios activos -->
          <div class="overview-card services-summary">
            <div class="card-header">
              <div class="card-icon services">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
              </div>
              <div class="card-title">
                <h4>Servicios</h4>
                <p>Actividad reciente</p>
              </div>
            </div>
            <div class="card-content">
              <div class="service-stats">
                <div class="stat-item">
                  <span class="stat-number">{{ clientStats?.services?.total || 0 }}</span>
                  <span class="stat-label">Completados</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                  <span class="stat-number">{{ clientStats?.services?.pending || 0 }}</span>
                  <span class="stat-label">Pendientes</span>
                </div>
              </div>
              <button class="card-action-btn" (click)="currentView = 'services'">
                Reservar nuevo servicio
              </button>
            </div>
          </div>

          <!-- Resumen de pagos -->
          <div class="overview-card payments-summary">
            <div class="card-header">
              <div class="card-icon payments">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <line x1="12" y1="1" x2="12" y2="23"/>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
              </div>
              <div class="card-title">
                <h4>Pagos</h4>
                <p>Estado financiero</p>
              </div>
            </div>
            <div class="card-content">
              <div class="payment-overview">
                <div class="total-amount">
                  <span class="amount">${{ clientStats?.financial?.total_spent?.toFixed(2) || '0.00' }}</span>
                  <span class="currency">MXN</span>
                </div>
                <div class="payment-breakdown">
                  <div class="breakdown-item confirmed">
                    <span class="count">{{ getCompletedPaymentsCount() }}</span>
                    <span class="label">Confirmados</span>
                  </div>
                  <div class="breakdown-item pending">
                    <span class="count">{{ getPendingPaymentsCount() }}</span>
                    <span class="label">Pendientes</span>
                  </div>
                </div>
              </div>
              <button class="card-action-btn" (click)="currentView = 'payments'">
                Gestionar pagos
              </button>
            </div>
          </div>
        </div>

        <!-- Secci√≥n de acceso r√°pido -->
        <div class="quick-access-section">
          <div class="section-header">
            <h3>Acceso R√°pido</h3>
            <p>Funciones m√°s utilizadas</p>
          </div>
          
          <div class="quick-access-grid">
            <button class="quick-access-item" (click)="currentView = 'services'">
              <div class="access-icon primary">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12,6 12,12 16,14"/>
                </svg>
              </div>
              <div class="access-content">
                <h4>Reservar Cuidadora</h4>
                <p>Programa un nuevo servicio</p>
              </div>
              <div class="access-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <polyline points="9,18 15,12 9,6"/>
                </svg>
              </div>
            </button>

            <button class="quick-access-item" (click)="openBankDetailsModal()">
              <div class="access-icon tertiary">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                  <line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
              </div>
              <div class="access-content">
                <h4>Datos Bancarios</h4>
                <p>Info para transferencias</p>
              </div>
              <div class="access-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <polyline points="9,18 15,12 9,6"/>
                </svg>
              </div>
            </button>

            <button class="quick-access-item" (click)="triggerReceiptUpload()">
              <div class="access-icon quaternary">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14,2 14,8 20,8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
              </div>
              <div class="access-content">
                <h4>Subir Comprobante</h4>
                <p>Adjuntar recibo de pago</p>
              </div>
              <div class="access-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <polyline points="9,18 15,12 9,6"/>
                </svg>
              </div>
            </button>
          </div>
        </div>

        <!-- √öltimos servicios (si los hay) -->
        <div class="recent-activity-section" *ngIf="contractedServices.length > 0">
          <div class="section-header">
            <h3>Actividad Reciente</h3>
            <p>Tus √∫ltimos servicios completados</p>
          </div>
          
          <div class="recent-services-list">
            <div *ngFor="let service of contractedServices.slice(0, 2)" class="recent-service-item">
              <div class="service-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
              </div>
              <div class="service-details">
                <h4>{{ service.title }}</h4>
                <p>{{ formatContractedServiceDate(service) }} ‚Ä¢ {{ service.nanny?.name || 'Sin asignar' }}</p>
              </div>
              <div class="service-status">
                <span class="status-badge completed">{{ service.status }}</span>
              </div>
            </div>
          </div>
          
          <button class="view-all-btn" (click)="currentView = 'contracted-services'">
            Ver todos los servicios
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <polyline points="9,18 15,12 9,6"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Vista de servicios contratados -->
      <div *ngIf="currentView === 'contracted-services'" class="contracted-services-view">
        <div class="content-header">
          <h2>Servicios</h2>
          <p>Detalles sobre el servicio</p>
        </div>

        <!-- Lista de servicios contratados -->
        <div class="contracted-services-container" *ngIf="!hasNoContractedServices()">
          <div *ngFor="let service of contractedServices" class="service-card contracted" [class.service-cancelled]="service.status === 'cancelled'">
            <div class="service-header-section">
              <div class="service-header-left">
                <h3 class="service-title">{{ service.title || service.service_type_name }}</h3>
                <p class="service-type">{{ service.service_type_name }}</p>
              </div>
              
              <!-- Estado del servicio -->
              <div class="status-badge" [ngClass]="{
                'status-confirmed': service.status === 'confirmed',
                'status-pending': service.status === 'pending',
                'status-completed': service.status === 'completed',
                'status-cancelled': service.status === 'cancelled',
                'status-in-progress': service.status === 'in_progress'
              }">
                <span class="status-dot"></span>
                <span class="status-text">{{ getStatusText(service.status) }}</span>
              </div>
            </div>
            
            <div class="service-content">
              <!-- Informaci√≥n del servicio -->
              <div class="service-info">
                <div class="service-details-grid">
                  <div class="detail-item">
                    <label>Fecha de Inicio</label>
                    <p>{{ service.start_date ? (service.start_date | date: 'dd/MM/yyyy') : 'No especificada' }}</p>
                  </div>
                  <div class="detail-item" *ngIf="service.end_date">
                    <label>Fecha de Fin</label>
                    <p>{{ service.end_date ? (service.end_date | date: 'dd/MM/yyyy') : 'No especificada' }}</p>
                  </div>
                  <div class="detail-item">
                    <label>Horario</label>
                    <p>{{ service.start_time }} - {{ service.end_time }}</p>
                  </div>
                  <div class="detail-item">
                    <label>Duraci√≥n</label>
                    <p>{{ service.total_hours }} horas</p>
                  </div>
                  <div class="detail-item" *ngIf="service.number_of_children">
                    <label>N√∫mero de Ni√±os</label>
                    <p>{{ service.number_of_children }}</p>
                  </div>
                  <div class="detail-item">
                    <label>Monto Total</label>
                    <p class="amount">${{ service.total_amount | number: '1.2-2' }} MXN</p>
                  </div>
                </div>
                
                <div class="service-address" *ngIf="service.address">
                  <label>Ubicaci√≥n</label>
                  <p>{{ service.address }}</p>
                </div>
              </div>

              <!-- Informaci√≥n de la nanny (oculta si est√° cancelado) -->
              <div class="nanny-info" *ngIf="service.status !== 'cancelled' && service.nanny_id">
                <div class="nanny-card">
                  <div class="nanny-avatar">
                    <img [src]="service.nanny_profile_image" [alt]="service.nanny_full_name" (error)="$event.target.src='assets/logo.png'">
                  </div>
                  <div class="nanny-details">
                    <p class="nanny-label">Nanny Asignada</p>
                    <p class="nanny-name">{{ service.nanny_full_name }}</p>
                    <button class="view-profile-btn" (click)="openNannyProfile(service)">
                      Ver perfil completo
                    </button>
                  </div>
                </div>
              </div>

              <!-- Instrucciones especiales -->
              <div class="special-instructions" *ngIf="service.special_instructions">
                <label>Instrucciones Especiales</label>
                <p>{{ service.special_instructions }}</p>
              </div>

              <!-- Mensaje de servicio cancelado -->
              <div class="cancelled-message" *ngIf="service.status === 'cancelled'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <line x1="7" y1="12" x2="17" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <p>Este servicio ha sido cancelado. No puedes realizar acciones sobre √©l.</p>
              </div>
            </div>

            <!-- Acciones del servicio contratado -->
            <div class="service-actions" *ngIf="service.status !== 'cancelled'">
              <!-- Bot√≥n para calificar -->
              <button 
                class="action-btn rate-btn" 
                *ngIf="!service.isRated && !service.showRating && service.status === 'completed'"
                (click)="rateService(service.id); $event.stopPropagation()">
                ‚≠ê Calificar
              </button>

              <!-- Sistema de calificaci√≥n con estrellas -->
              <div class="rating-system" *ngIf="service.showRating">
                <h4>Califica el servicio:</h4>
                <div class="stars-container">
                  <span 
                    *ngFor="let star of getStarsArray()" 
                    class="star"
                    (click)="setRating(service.id, star)"
                    [class.filled]="star <= (service.tempRating || 0)"
                    (mouseenter)="onStarHover(service.id, star)"
                    (mouseleave)="onStarLeave(service.id)">
                    ‚≠ê
                  </span>
                </div>
                <div class="rating-actions">
                  <button class="cancel-rating-btn" (click)="cancelRating(service.id); $event.stopPropagation()">
                    Cancelar
                  </button>
                </div>
              </div>

              <!-- Servicio ya calificado -->
              <div class="rated-badge" *ngIf="service.isRated">
                <div class="rating-display">
                  <span class="rating-text">Calificado:</span>
                  <div class="rating-stars">
                    <span 
                      *ngFor="let star of getStarsArray()" 
                      class="star"
                      [class.filled]="star <= (service.rating.rating || 0)">
                      ‚≠ê
                    </span>
                  </div>
                </div>
              </div>

              <!-- Bot√≥n para ver datos bancarios espec√≠ficos de la nanny -->
              <button class="bank-details-btn" (click)="openBankDetailsModal(service.nanny?.id); $event.stopPropagation()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                  <line x1="1" y1="10" x2="23" y2="10" stroke="currentColor" stroke-width="2"/>
                </svg>
                Ver Datos Bancarios
              </button>

              <!-- Bot√≥n para cancelar servicio -->
              <button class="action-btn cancel-btn" 
                (click)="selectedService = service; confirmCancelService(); $event.stopPropagation()"
                *ngIf="service.status === 'pending' || service.status === 'confirmed'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Cancelar Servicio
              </button>
            </div>

            <!-- Mensaje de servicio cancelado -->
            <div class="service-cancelled-message" *ngIf="service.status === 'cancelled'">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <p>Servicio cancelado</p>
            </div>
          </div>
        </div>

        <!-- Mensaje cuando no hay servicios contratados -->
        <div class="no-services-message" *ngIf="hasNoContractedServices()">
          <div class="no-services-content">
            <h3>No tienes servicios contratados a√∫n</h3>
            <p>Cuando contrates servicios, aparecer√°n aqu√≠ despu√©s de completarse.</p>
            <button class="book-service-btn" (click)="currentView = 'services'">
              Contratar Servicio
            </button>
          </div>
        </div>
      </div>

      <!-- Vista de detalles del servicio -->
      <div *ngIf="currentView === 'service-details' && selectedService" class="service-details-view">
        <div class="content-header">
          <button class="back-button" (click)="backToServices()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Volver a servicios
          </button>
          <h2>Detalles del servicio</h2>
          <p>Informaci√≥n completa sobre tu servicio contratado</p>
        </div>

        <div class="service-details-container">
          <!-- Columna principal -->
          <div class="details-main-column">
            <!-- Tarjeta de informaci√≥n general -->
            <div class="detail-card">
              <div class="card-header">
                <h3>{{ selectedService.title }}</h3>
                <div class="status-badge" [ngClass]="{
                  'status-confirmed': selectedService.status === 'confirmed',
                  'status-pending': selectedService.status === 'pending',
                  'status-completed': selectedService.status === 'completed',
                  'status-cancelled': selectedService.status === 'cancelled'
                }">
                  <span class="status-dot"></span>
                  <span>{{ getStatusText(selectedService.status) }}</span>
                </div>
              </div>

              <div class="detail-grid">
                <div class="detail-item">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                    <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <div class="detail-content">
                    <span class="detail-label">{{ selectedService.end_date ? 'Fecha de Inicio' : 'Fecha' }}</span>
                    <span class="detail-value">{{ formatDate(selectedService.start_date) }}</span>
                  </div>
                </div>

                <div class="detail-item" *ngIf="selectedService.end_date">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                    <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <div class="detail-content">
                    <span class="detail-label">Fecha de Fin</span>
                    <span class="detail-value">{{ formatDate(selectedService.end_date) }}</span>
                  </div>
                </div>

                <div class="detail-item">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  <div class="detail-content">
                    <span class="detail-label">Horario</span>
                    <span class="detail-value">{{ selectedService.start_time }} - {{ selectedService.end_time }}</span>
                  </div>
                </div>

                <div class="detail-item">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2v20M2 12h20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <div class="detail-content">
                    <span class="detail-label">Duraci√≥n</span>
                    <span class="detail-value">{{ selectedService.total_hours }} horas</span>
                  </div>
                </div>

                <div class="detail-item">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <div class="detail-content">
                    <span class="detail-label">N√∫mero de ni√±os</span>
                    <span class="detail-value">{{ selectedService.number_of_children }}</span>
                  </div>
                </div>

                <div class="detail-item">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" stroke="currentColor" stroke-width="2"/>
                    <circle cx="12" cy="9" r="2.5" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <div class="detail-content">
                    <span class="detail-label">Direcci√≥n</span>
                    <span class="detail-value">{{ selectedService.address || 'No especificada' }}</span>
                  </div>
                </div>

                <div class="detail-item highlight">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="12" y1="1" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  <div class="detail-content">
                    <span class="detail-label">Monto total</span>
                    <span class="detail-value price">${{ selectedService.total_amount }} MXN</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tarjeta de indicaciones especiales -->
            <div class="detail-card">
              <div class="card-header">
                <h3>Indicaciones especiales</h3>
                <button 
                  *ngIf="selectedService.status !== 'completed' && selectedService.status !== 'cancelled' && !isEditingInstructions"
                  class="edit-btn"
                  (click)="startEditingInstructions()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  Editar
                </button>
              </div>

              <div class="instructions-content" *ngIf="!isEditingInstructions">
                <p *ngIf="selectedService.special_instructions">{{ selectedService.special_instructions }}</p>
                <p *ngIf="!selectedService.special_instructions" class="no-instructions">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2"/>
                    <polyline points="14 2 14 8 20 8" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="18" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="12" y1="9" x2="12.01" y2="9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  No hay indicaciones especiales para este servicio
                </p>
              </div>

              <div class="instructions-editor" *ngIf="isEditingInstructions">
                <textarea 
                  class="instructions-textarea"
                  [(ngModel)]="serviceInstructions"
                  placeholder="Escribe las indicaciones especiales para la ni√±era (por ejemplo: alergias, rutinas, medicamentos, horarios de comida, etc.)"
                  rows="6">
                </textarea>
                <div class="editor-actions">
                  <button class="save-btn" (click)="saveInstructions()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Guardar
                  </button>
                  <button class="cancel-btn" (click)="cancelEditingInstructions()">
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Columna lateral -->
          <div class="details-sidebar">
            <!-- Tarjeta de la ni√±era -->
            <div class="detail-card nanny-card" *ngIf="selectedService.nanny">
              <div class="card-header">
                <h3>Ni√±era asignada</h3>
              </div>
              
              <div class="nanny-profile">
                <div class="nanny-avatar-large">
                  <img [src]="selectedService.nanny.profile_image || 'assets/logo.png'" [alt]="selectedService.nanny.name">
                </div>
                <h4 class="nanny-name">{{ selectedService.nanny.name }}</h4>
                <div class="nanny-rating" *ngIf="selectedService.nanny.rating">
                  <div class="stars-display">
                    <svg *ngFor="let star of [1,2,3,4,5]" 
                         [class.filled]="star <= selectedService.nanny.rating"
                         width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L13.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
                    </svg>
                  </div>
                  <span class="rating-value">{{ selectedService.nanny.rating }}/5</span>
                </div>
                <button class="view-profile-btn" (click)="showNannyProfileModal(selectedService.nanny)">
                  Ver perfil completo
                </button>
              </div>
            </div>

            <!-- Tarjeta de acciones -->
            <div class="detail-card actions-card" *ngIf="selectedService.status !== 'cancelled' && selectedService.status !== 'completed'">
              <div class="card-header">
                <h3>Acciones</h3>
              </div>
              
              <div class="actions-list">
                <!-- Bot√≥n para cambiar fecha -->
                <button class="action-btn change-date-btn" *ngIf="selectedService.status === 'pending' || selectedService.status === 'confirmed'">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                    <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Cambiar Fecha
                </button>

                <!-- Bot√≥n para cancelar -->
                <button class="action-btn cancel-btn" (click)="confirmCancelService()" *ngIf="selectedService.status !== 'cancelled'">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  Cancelar Servicio
                </button>
              </div>
            </div>

            <!-- Tarjeta de servicio cancelado -->
            <div class="detail-card cancelled-info" *ngIf="selectedService.status === 'cancelled'">
              <div class="cancelled-message">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <p>Este servicio ha sido cancelado</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista Servicios -->
      <div *ngIf="currentView === 'services'">
        <!-- Vista del historial de servicios (por defecto) -->
        <div *ngIf="servicesView === 'services-history'">
          <div class="content-header">
            <h2>Mis Servicios</h2>
            <p>Historial de servicios completados y calificaciones</p>
            <button class="contracted-services-btn" (click)="showNewServiceForm()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C13.1 2 14 2.9 14 4V10H20C21.1 10 22 10.9 22 12C22 13.1 21.1 14 20 14H14V20C14 21.1 13.1 22 12 22C10.9 22 10 21.1 10 20V14H4C2.9 14 2 13.1 2 12C2 10.9 2.9 10 4 10H10V4C10 2.9 10.9 2 12 2Z"/>
              </svg>
              Nuevo Servicio
            </button>
          </div>

          <!-- Lista de servicios del historial -->
          <div class="services-history-container">
            <div *ngFor="let service of contractedServices" 
                 class="service-history-card">
              <!-- Header del servicio -->
              <div class="service-header">
                <div class="service-info-left">
                  <h3 class="service-title">{{ service.title }}</h3>
                  <p class="service-type">{{ service.service_type || service.service?.name }}</p>
                  <p class="service-date">{{ formatContractedServiceDate(service) }}</p>
                </div>
                <div class="service-status">
                  <span class="status-badge" [ngClass]="{
                    'status-confirmed': service.status === 'confirmed',
                    'status-pending': service.status === 'pending',
                    'status-completed': service.status === 'completed',
                    'status-cancelled': service.status === 'cancelled',
                    'status-in-progress': service.status === 'in_progress'
                  }">{{ getStatusText(service.status) }}</span>
                </div>
              </div>

              <!-- Detalles del servicio -->
              <div class="service-details-row">
                <div class="nanny-info-compact">
                  <img [src]="service.nanny_profile_image || service.nanny?.profile_image || 'assets/logo.png'" [alt]="service.nanny_full_name || service.nanny?.name || 'Nanny'" class="nanny-avatar-small">
                  <div class="nanny-details">
                    <span class="nanny-name">{{ service.nanny_full_name || service.nanny?.name || 'Sin asignar' }}</span>
                    <span class="nanny-role">Ni√±era certificada</span>
                  </div>
                </div>

                <!-- Secci√≥n de calificaci√≥n -->
                <div class="rating-section">
                  <div *ngIf="service.isRated" class="rating-display">
                    <div class="stars-display">
                      <svg *ngFor="let star of getStarsArray()" 
                           [class.filled]="star <= (service.rating.rating || 0)"
                           class="star-icon" width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L13.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
                      </svg>
                    </div>
                    <span class="rating-text">{{ getRatingText(service.rating.rating || 0) }}</span>
                  </div>

                  <div *ngIf="!service.isRated && !service.showRating && service.status === 'completed'" class="rating-action">
                    <button class="rate-btn" (click)="rateService(service.id); $event.stopPropagation()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L13.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
                      </svg>
                      Calificar
                    </button>
                  </div>

                  <!-- Sistema de calificaci√≥n activo -->
                  <div *ngIf="service.showRating" class="rating-input">
                    <div class="rating-prompt">
                      <span>¬øC√≥mo fue tu experiencia?</span>
                    </div>
                    <div class="stars-input">
                      <svg *ngFor="let star of getStarsArray()" 
                           [class.filled]="star <= (service.tempRating || 0)"
                           class="star-input" 
                           width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                           (click)="setRating(service.id, star)"
                           (mouseenter)="onStarHover(service.id, star)"
                           (mouseleave)="onStarLeave(service.id)">
                        <path d="M12 2L13.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
                      </svg>
                    </div>
                    <div class="rating-hint" *ngIf="(service.tempRating || 0) > 0">
                      <span>{{ getRatingText(service.tempRating || 0) }}</span>
                    </div>
                    <div class="rating-actions">
                      <button class="cancel-rating-btn" (click)="cancelRating(service.id)">
                        Cancelar
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Acciones del servicio -->
              <div class="service-actions-compact">
                <button class="action-btn view-details" (click)="viewServiceDetails(service.id)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM12.5 7H11V13L16.2 16.5L17 15.1L12.5 12.4V7Z"/>
                  </svg>
                  Ver detalles
                </button>

                <button class="action-btn view-details" (click)="openBankDetailsModal(service.nanny?.id)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 4C2 3.45 2.45 3 3 3H21C21.55 3 22 3.45 22 4V20C22 20.55 21.55 21 21 21H3C2.45 21 2 20.55 2 20V4ZM4 5V19H20V5H4ZM6 7H18V9H6V7ZM6 11H14V13H6V11ZM6 15H10V17H6V15Z"/>
                  </svg>
                  Datos bancarios
                </button>

                <!-- Bot√≥n de pago si el servicio est√° completado -->
                <button *ngIf="service.status === 'completed'" 
                        class="action-btn payment-btn" 
                        (click)="createPaymentForService(service.id)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM16.5 11.5C16.5 14.04 14.54 16.05 12.2 16.2V17H11.8V16.2C9.46 16.05 7.5 14.04 7.5 11.5H9C9 13.16 10.34 14.5 12 14.5C13.66 14.5 15 13.16 15 11.5C15 10.17 14.2 9.03 13 8.6V5H11.5V8.6C10.3 9.03 9.5 10.17 9.5 11.5H8C8 14.04 9.96 16.05 12.3 16.2V17H12.7V16.2C15.04 16.05 17 14.04 17 11.5H15.5C15.5 12.88 14.38 14 13 14C11.62 14 10.5 12.88 10.5 11.5C10.5 10.12 11.62 9 13 9C14.38 9 15.5 10.12 15.5 11.5Z"/>
                  </svg>
                  Pagar servicio
                </button>
                
                <div class="service-cost">
                  <span class="cost-label">Costo:</span>
                  <span class="cost-amount">${{ service.total_amount | number: '1.2-2' }} MXN</span>
                </div>
              </div>

              <!-- Instrucciones si las hay -->
              <div *ngIf="service.special_instructions || service.instructions" class="service-instructions">
                <h5>Instrucciones especiales:</h5>
                <p>{{ service.special_instructions || service.instructions }}</p>
              </div>
            </div>

            <!-- Mensaje cuando no hay servicios -->
            <div class="no-services-message" *ngIf="contractedServices.length === 0">
              <div class="no-services-content">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="#e5e7eb" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2L13.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
                </svg>
                <h3>No tienes servicios completados</h3>
                <p>Cuando contrates y completes servicios, aparecer√°n aqu√≠.</p>
                <button class="book-service-btn" (click)="showNewServiceForm()">
                  Contratar primer servicio
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Vista del formulario para nuevo servicio -->
        <div *ngIf="servicesView === 'new-service'">
          <div class="content-header">
            <button class="back-btn" (click)="showServicesHistory()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 11H7.83L13.42 5.41L12 4L4 12L12 20L13.41 18.59L7.83 13H20V11Z"/>
              </svg>
              Volver al historial
            </button>
            <h2>Nuevo Servicio</h2>
            <p>Selecciona fecha, hora y tipo de servicio</p>
          </div>
          
          <div class="services-container">
            <!-- Columna izquierda: Formularios -->
            <div class="left-column">
              <!-- Selector de tipo de servicio -->
              <div class="service-type-section">
                <div class="service-type-card">
                  <div class="service-type-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#6b7280" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L13.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
                    </svg>
                    <span>Tipo de servicio</span>
                  </div>
                  
                  <div class="service-selector">
                    <select class="service-select" 
                            [value]="selectedServiceType" 
                            (change)="onServiceTypeChange($event)">
                      <option value="">Selecciona un servicio</option>
                      <option *ngFor="let service of serviceTypes" [value]="service.id">
                        {{ service.name }}
                      </option>
                    </select>
                    
                    <div class="service-description" *ngIf="selectedServiceType">
                      <p>{{ getSelectedServiceDescription() }}</p>
                      <div class="multiple-days-info" *ngIf="allowsMultipleDays()">
                        <p class="info-text">
                          <strong>üìÖ Servicio de m√∫ltiples d√≠as:</strong> 
                          Puedes seleccionar un rango de fechas consecutivas
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Selector de ni√±os y nannys -->
              <div class="children-nannys-section">
                <div class="children-nannys-card">
                  <div class="selection-grid">
                    <!-- Selector de n√∫mero de ni√±os -->
                    <div class="selection-item">
                      <div class="selection-header">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#6b7280" xmlns="http://www.w3.org/2000/svg">
                          <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2M4 18v-6h3v-3.5c0-1.1.9-2 2-2s2 .9 2 2V12h3v6H4z"/>
                          <circle cx="12" cy="8" r="2"/>
                          <path d="M15 13v5h-2v-8.5c0-1.1-.9-2-2-2s-2 .9-2 2V18H7v-5"/>
                        </svg>
                        <span>N√∫mero de ni√±os</span>
                      </div>
                      <select class="selection-select" 
                              [value]="selectedChildren" 
                              (change)="onChildrenChange($event)">
                        <option *ngFor="let num of getChildrenOptions()" [value]="num">
                          {{ num }} {{ num === 1 ? 'ni√±o' : 'ni√±os' }}
                        </option>
                      </select>
                    </div>

                  </div>

                  <!-- Informaci√≥n sobre asignaci√≥n de nanny -->
                  <div class="nanny-assignment-info" style="margin-top: 1.5rem; background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 8px;">
                    <div style="display: flex; gap: 12px;">
                      <div style="flex-shrink: 0;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#3b82f6" xmlns="http://www.w3.org/2000/svg">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                      </div>
                      <div>
                        <p style="margin: 0 0 8px 0; font-weight: 600; color: #1e40af; font-size: 0.9rem;">¬øC√≥mo funciona la asignaci√≥n?</p>
                        <p style="margin: 0; color: #1e40af; font-size: 0.85rem; line-height: 1.5;">Todas las nannys disponibles recibir√°n una notificaci√≥n sobre tu servicio. La primera en aceptar ser√° asignada autom√°ticamente. Te notificaremos cuando esto suceda.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Selector de horarios y confirmaci√≥n -->
              <div class="booking-section">
                <!-- Selector de horario de llegada -->
                <div class="time-selector-card">
                  <div class="time-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#6b7280" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span>Horario de Llegada</span>
                    <span class="time-info" *ngIf="isNightService()">üåô Servicio nocturno</span>
                  </div>
                  
                  <div class="time-grid" *ngIf="selectedDate && selectedServiceType">
                    <button *ngFor="let time of getAvailableTimesForService()" 
                            class="time-slot"
                            [class.selected]="selectedStartTime === time"
                            [class.night-time]="isNightService()"
                            (click)="selectStartTime(time)">
                      {{ time }}
                    </button>
                  </div>
                  
                  <div class="no-date-selected" *ngIf="!selectedDate || !selectedServiceType">
                    <p *ngIf="!selectedServiceType">Selecciona un tipo de servicio primero</p>
                    <p *ngIf="selectedServiceType && !selectedDate">Selecciona una fecha</p>
                  </div>
                </div>

                <!-- Selector de horario de salida -->
                <div class="time-selector-card" *ngIf="selectedStartTime">
                  <div class="time-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#6b7280" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span>Horario de Salida</span>
                    <span class="selected-start-time">‚úì Llegada: {{ selectedStartTime }}</span>
                  </div>
                  
                  <div class="time-grid">
                    <button *ngFor="let time of getAvailableEndTimes()" 
                            class="time-slot"
                            [class.selected]="selectedEndTime === time"
                            [class.night-time]="isNightService()"
                            [disabled]="!isValidEndTime(time)"
                            (click)="selectEndTime(time)">
                      {{ time }}
                    </button>
                  </div>
                </div>

                <!-- Reserva seleccionada -->
                <div class="reservation-card">
                  <h3>Reserva seleccionada:</h3>
                  <div class="reservation-info" *ngIf="hasValidReservation()">
                    <p><strong>Servicio:</strong> {{ getSelectedServiceName() }}</p>
                    <p><strong>Fechas:</strong> {{ getDateRangeText() }}</p>
                    <p><strong>Horario de llegada:</strong> {{ selectedStartTime }}</p>
                    <p><strong>Horario de salida:</strong> {{ selectedEndTime }}</p>
                    <p><strong>Duraci√≥n:</strong> {{ calculateDuration() }}</p>
                    <p><strong>Horas totales:</strong> {{ calculateTotalHoursDecimal() }} horas</p>
                    <p><strong>Ni√±os:</strong> {{ selectedChildren }} {{ selectedChildren === 1 ? 'ni√±o' : 'ni√±os' }}</p>
                  </div>
                  <div class="no-reservation" *ngIf="!hasValidReservation()">
                    <p>aqu√≠ se mostrar√° el servicio, fecha(s), horarios y ni√±os</p>
                  </div>
                  
                  <div class="action-buttons">
                    <button class="confirm-btn" 
                            [disabled]="!hasValidReservation()"
                            (click)="confirmReservation()">
                      Confirmar
                    </button>
                    <button class="cancel-btn" 
                            [disabled]="!hasValidReservation()"
                            (click)="cancelReservation()">
                      Cancelar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Columna derecha: Calendario -->
            <div class="right-column">
              <div class="calendar-section">
                <div class="calendar-card">
                  <div class="calendar-header">
                    <button class="nav-btn" (click)="previousMonth()">‚Äπ</button>
                    <h3>{{ getMonthName() }}</h3>
                    <button class="nav-btn" (click)="nextMonth()">‚Ä∫</button>
                  </div>
                  
                  <div class="calendar-subtitle">
                    <span *ngIf="!allowsMultipleDays()">Selecciona una fecha</span>
                    <span *ngIf="allowsMultipleDays()">Selecciona fecha de inicio y fin (d√≠as consecutivos)</span>
                  </div>
                  
                  <!-- Indicador de estado de selecci√≥n -->
                  <div class="selection-status" *ngIf="allowsMultipleDays()">
                    <span class="status-text">{{ getSelectionState() }}</span>
                    <div class="legend" *ngIf="selectedDate">
                      <div class="legend-item">
                        <span class="legend-color start-color"></span>
                        <span>Inicio</span>
                      </div>
                      <div class="legend-item" *ngIf="selectedEndDate">
                        <span class="legend-color end-color"></span>
                        <span>Fin</span>
                      </div>
                      <div class="legend-item" *ngIf="selectedEndDate">
                        <span class="legend-color range-color"></span>
                        <span>Rango</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="calendar-grid">
                    <!-- Nombres de los d√≠as -->
                    <div class="day-names">
                      <div *ngFor="let dayName of getDayNames()" class="day-name">
                        {{ dayName }}
                      </div>
                    </div>
                    
                    <!-- D√≠as del mes -->
                    <div class="days-grid">
                      <div *ngFor="let day of getDaysInMonth()" 
                           class="day-cell"
                           [class.empty]="day === 0"
                           [class.selected]="isSelectedDate(day)"
                           [class.start-date]="isStartDate(day)"
                           [class.end-date]="isEndDate(day)"
                           [class.in-range]="isInSelectedRange(day)"
                           [class.past]="isPastDate(day)"
                           [class.available]="day > 0 && !isPastDate(day)"
                           (click)="selectDate(day)">
                        {{ day || '' }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista Pagos -->
      <div *ngIf="currentView === 'payments'" class="payments-view">
        <div class="content-header">
          <h2>Gesti√≥n de Pagos</h2>
          <p>Administra tus pagos y transferencias de manera segura</p>
        </div>

        <div class="payments-main-container">
          <!-- Resumen de estad√≠sticas modernizado -->
          <div class="payment-stats-section">
            <div class="stats-header">
              <h3>Resumen de Pagos</h3>
              <p>Estado actual de tus transacciones</p>
            </div>
            
            <div class="stats-grid-modern">
              <div class="stat-card-modern pending">
                <div class="stat-card-header">
                  <div class="stat-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                      <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="stat-info">
                    <span class="stat-number">{{ getPendingPaymentsCount() }}</span>
                    <span class="stat-label">Pendientes</span>
                  </div>
                </div>
              </div>

              <div class="stat-card-modern processing">
                <div class="stat-card-header">
                  <div class="stat-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2a10 10 0 0 1 10 10v.5c0 .82-.67 1.5-1.5 1.5S19 13.32 19 12.5V12a7 7 0 0 0-14 0v.5c0 .82-.67 1.5-1.5 1.5S2 13.32 2 12.5V12a10 10 0 0 1 10-10z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                  </div>
                  <div class="stat-info">
                    <span class="stat-number">{{ getProcessingPaymentsCount() }}</span>
                    <span class="stat-label">En Verificaci√≥n</span>
                  </div>
                </div>
              </div>

              <div class="stat-card-modern completed">
                <div class="stat-card-header">
                  <div class="stat-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <polyline points="22,4 12,14.01 9,11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="stat-info">
                    <span class="stat-number">{{ getCompletedPaymentsCount() }}</span>
                    <span class="stat-label">Completados</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Lista de servicios con pagos -->
          <div class="services-payment-section">
            <div class="section-header">
              <h3>Servicios y Pagos</h3>
              <p>Servicios completados que requieren pago</p>
            </div>

            <!-- Filtros de pagos -->
            <div class="payment-filters" *ngIf="clientPayments && clientPayments.length > 0">
              <div class="filter-group">
                <label for="statusFilter">Filtrar por estado:</label>
                <select id="statusFilter" [(ngModel)]="selectedPaymentStatus" class="filter-select">
                  <option value="">Todos los estados</option>
                  <option value="pending">Pendientes</option>
                  <option value="processing">En Verificaci√≥n</option>
                  <option value="completed">Completados</option>
                  <option value="failed">Fallidos</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="dateFilter">Ordenar por fecha:</label>
                <select id="dateFilter" [(ngModel)]="sortPaymentsBy" class="filter-select">
                  <option value="recent">M√°s Reciente</option>
                  <option value="oldest">M√°s Antiguo</option>
                </select>
              </div>

              <div class="filter-info">
                Mostrando {{ getFilteredPayments().length }} de {{ clientPayments.length }} servicios
              </div>
            </div>

            <!-- Si hay servicios que pagar -->
            <div class="payment-services-grid" *ngIf="getFilteredPayments() && getFilteredPayments().length > 0">
              <div *ngFor="let payment of getFilteredPayments()" class="payment-service-card">
                <!-- Header del pago (Desplegable) -->
                <div class="payment-card-header" 
                     (click)="togglePaymentExpanded(payment.id)"
                     [class.expanded]="isPaymentExpanded(payment.id)"
                     role="button"
                     tabindex="0">
                  <div class="payment-header-left">
                    <div class="toggle-arrow">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <polyline points="6 9 12 15 18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="header-info">
                      <h3 class="service-title">{{ payment.service?.title || 'Servicio' }}</h3>
                      <span class="payment-id">#{{ payment.id }} - {{ payment.start_date | date: 'dd/MM/yyyy' }}</span>
                    </div>
                  </div>
                  <span class="payment-status-badge" [ngClass]="'status-' + payment.payment_status">
                    {{ formatPaymentStatus(payment.payment_status) }}
                  </span>
                </div>

                <!-- Contenido desplegable -->
                <div class="payment-content" *ngIf="isPaymentExpanded(payment.id)">
                  <!-- Fila 1: Informaci√≥n de la nanny -->
                  <div class="info-row nanny-info">
                    <div class="info-item">
                      <span class="info-label">Ni√±era:</span>
                      <span class="info-value">{{ payment.nanny_first_name }} {{ payment.nanny_last_name }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Tipo de servicio:</span>
                      <span class="info-value">{{ payment.service?.name || 'No especificado' }}</span>
                    </div>
                  </div>

                  <!-- Fila 2: Fechas y horas -->
                  <div class="info-row dates-info">
                    <div class="info-item">
                      <span class="info-label">Horario:</span>
                      <span class="info-value">{{ payment.start_time }} - {{ payment.end_time }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Monto Total:</span>
                      <span class="info-value amount">{{ payment.amount | currency }}</span>
                    </div>
                  </div>

                  <!-- Detalles del pago -->
                  <div class="payment-details">
                    <div class="detail-item">
                      <span class="detail-label">Comisi√≥n plataforma:</span>
                      <span class="detail-value">{{ payment.platform_fee | currency }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Para la ni√±era:</span>
                      <span class="detail-value">{{ payment.nanny_amount | currency }}</span>
                    </div>
                  </div>

                  <!-- Preview del comprobante si existe -->
                  <div class="receipt-preview-section" *ngIf="payment.receipt_url && payment.payment_status !== 'pending'">
                    <div class="receipt-header">
                      <h4>Comprobante de Pago</h4>
                    </div>
                    <div class="receipt-preview">
                      <!-- Si es imagen -->
                      <div class="receipt-image" *ngIf="isImageReceipt(payment.receipt_url)">
                        <img [src]="getProperReceiptUrl(payment.receipt_url)" 
                             alt="Comprobante" 
                             class="receipt-thumbnail"
                             (error)="onReceiptImageError($event, payment.id)">
                      </div>
                      <!-- Si es PDF -->
                      <div class="receipt-pdf" *ngIf="isPdfReceipt(payment.receipt_url)">
                        <div class="pdf-icon">
                          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" stroke="currentColor" stroke-width="2"/>
                            <polyline points="13,2 13,9 20,9" stroke="currentColor" stroke-width="2"/>
                          </svg>
                        </div>
                        <a [href]="getProperReceiptUrl(payment.receipt_url)" target="_blank" class="pdf-link">
                          <span class="pdf-name">Descargar Comprobante (PDF)</span>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6" stroke="currentColor" stroke-width="2"/>
                            <polyline points="15 3 21 3 21 9" stroke="currentColor" stroke-width="2"/>
                            <line x1="10" y1="14" x2="21" y2="3" stroke="currentColor" stroke-width="2"/>
                          </svg>
                        </a>
                      </div>
                    </div>
                  </div>

                  <!-- Acciones seg√∫n estado -->
                  <div class="payment-actions">
                    <!-- Si est√° pendiente, mostrar bot√≥n de subir -->
                    <button *ngIf="payment.payment_status === 'pending'" 
                            class="action-btn upload-btn"
                            (click)="openUploadReceiptModal(payment.id)">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2"/>
                        <polyline points="7,10 12,15 17,10" stroke="currentColor" stroke-width="2"/>
                        <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2"/>
                      </svg>
                      Subir Comprobante
                    </button>

                    <!-- Si est√° en procesamiento, mostrar estado -->
                    <div *ngIf="payment.payment_status === 'processing'" class="status-message processing">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2"/>
                      </svg>
                      En verificaci√≥n por el administrador
                    </div>

                    <!-- Si est√° completado, mostrar confirmaci√≥n -->
                    <div *ngIf="payment.payment_status === 'completed'" class="status-message completed">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 12l2 2 4-4m7-2a10 10 0 1 1-20 0 10 10 0 0 1 20 0z" stroke="currentColor" stroke-width="2"/>
                      </svg>
                      Pago completado
                    </div>

                    <!-- Si fall√≥, mostrar bot√≥n de reintentar -->
                    <button *ngIf="payment.payment_status === 'failed'" 
                            class="action-btn retry-btn"
                            (click)="openUploadReceiptModal(payment.id)">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 4v6h6M23 20v-6h-6" stroke="currentColor" stroke-width="2"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2"/>
                      </svg>
                      Reintentar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Si no hay pagos con los filtros aplicados -->
            <div class="no-payments-state" *ngIf="(!getFilteredPayments() || getFilteredPayments().length === 0) && clientPayments && clientPayments.length > 0">
              <div class="empty-icon">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2" stroke="#e5e7eb" stroke-width="2"/>
                  <line x1="1" y1="10" x2="23" y2="10" stroke="#e5e7eb" stroke-width="2"/>
                  <circle cx="12" cy="14" r="2" fill="#e5e7eb"/>
                </svg>
              </div>
              <h3>No hay servicios que coincidan con los filtros</h3>
              <p>Intenta cambiar los filtros para ver otros servicios.</p>
            </div>

            <!-- Si no hay pagos en absoluto -->
            <div class="no-payments-state" *ngIf="!clientPayments || clientPayments.length === 0">
              <div class="empty-icon">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2" stroke="#e5e7eb" stroke-width="2"/>
                  <line x1="1" y1="10" x2="23" y2="10" stroke="#e5e7eb" stroke-width="2"/>
                  <circle cx="12" cy="14" r="2" fill="#e5e7eb"/>
                </svg>
              </div>
              <h3>No hay servicios pendientes de pago</h3>
              <p>Cuando completes un servicio, aparecer√° aqu√≠ para gestionar el pago.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de Datos Bancarios -->
      <div class="bank-modal-overlay" *ngIf="showBankDetailsModal" (click)="showBankDetailsModal = false">
        <div class="bank-modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Datos Bancarios para Transferencia</h3>
            <button class="close-btn" (click)="showBankDetailsModal = false">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>

          <!-- Loader mientras se cargan los datos -->
          <div *ngIf="isLoadingBankData" class="bank-data-loader">
            <div class="spinner"></div>
            <p>Cargando datos bancarios...</p>
          </div>

          <!-- Contenido del modal (solo se muestra cuando no est√° cargando) -->
          <div *ngIf="!isLoadingBankData">
            <!-- Tarjeta bancaria simulada -->
            <div class="bank-card">
              <div class="card-background">
                <div class="card-pattern"></div>
                <div class="card-content">
                  <div class="card-header">
                    <div class="bank-logo">
                      <svg width="40" height="40" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                      </svg>
                    </div>
                    <div class="card-type">
                      <span>{{ currentBankData?.banco || 'BANCO NACIONAL' }}</span>
                    </div>
                  </div>

                  <div class="card-number">
                    <span class="number-group">{{ (currentBankData?.numero_cuenta || '1234567890123456').slice(0, 4) }}</span>
                    <span class="number-group">{{ (currentBankData?.numero_cuenta || '1234567890123456').slice(4, 8) }}</span>
                    <span class="number-group">{{ (currentBankData?.numero_cuenta || '1234567890123456').slice(8, 12) }}</span>
                    <span class="number-group">{{ (currentBankData?.numero_cuenta || '1234567890123456').slice(12, 16) }}</span>
                  </div>

                  <div class="card-info">
                    <div class="card-holder">
                      <span class="label">TITULAR</span>
                      <span class="value">{{ (currentBankData?.nombre_titular || 'NANNYS LM SERVICIOS').toUpperCase() }}</span>
                    </div>
                    <div class="card-expiry">
                      <span class="label">VIGENCIA</span>
                      <span class="value">12/28</span>
                    </div>
                  </div>

                  <div class="chip">
                    <div class="chip-lines"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Detalles adicionales -->
            <div class="bank-details-grid">
            <div class="detail-item">
              <div class="detail-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#E31B7E" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                  <path d="M2 17l10 5 10-5"/>
                  <path d="M2 12l10 5 10-5"/>
                </svg>
              </div>
              <div class="detail-info">
                <span class="detail-label">Banco</span>
                <span class="detail-value">{{ currentBankData?.banco || 'Banco Nacional de Desarrollo' }}</span>
              </div>
            </div>

            <div class="detail-item">
              <div class="detail-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#E31B7E" xmlns="http://www.w3.org/2000/svg">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
              </div>
              <div class="detail-info">
                <span class="detail-label">Titular</span>
                <span class="detail-value">{{ currentBankData?.nombre_titular || 'NannysLM Servicios S.A.' }}</span>
              </div>
            </div>

            <div class="detail-item">
              <div class="detail-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#E31B7E" xmlns="http://www.w3.org/2000/svg">
                  <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                  <line x1="8" y1="21" x2="16" y2="21"/>
                  <line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
              </div>
              <div class="detail-info">
                <span class="detail-label">N√∫mero de Cuenta</span>
                <span class="detail-value">{{ currentBankData?.numero_cuenta || '1234-5678-9012-3456' }}</span>
              </div>
            </div>

            <div class="detail-item" *ngIf="currentBankData?.clabe">
              <div class="detail-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#E31B7E" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                  <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                  <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
              </div>
              <div class="detail-info">
                <span class="detail-label">CLABE Interbancaria</span>
                <span class="detail-value">{{ currentBankData.clabe }}</span>
              </div>
            </div>

            <div class="detail-item">
              <div class="detail-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#E31B7E" xmlns="http://www.w3.org/2000/svg">
                  <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h13a1 1 0 0 1 1 1z"/>
                  <path d="M3 20.25A2.25 2.25 0 0 0 5.25 22.5h13.5A2.25 2.25 0 0 0 21 20.25V16.5A2.25 2.25 0 0 0 18.75 14.25H5.25A2.25 2.25 0 0 0 3 16.5z"/>
                </svg>
              </div>
              <div class="detail-info">
                <span class="detail-label">Tipo de Cuenta</span>
                <span class="detail-value">{{ currentBankData?.tipo_cuenta === 'ahorro' ? 'Cuenta de Ahorro' : 'Cuenta Corriente' }}</span>
              </div>
            </div>
          </div>

          <!-- Instrucciones -->
          <div class="transfer-instructions">
            <h4>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="#E31B7E" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
              Instrucciones para la Transferencia
            </h4>
            <ul>
              <li>Realiza la transferencia por el monto exacto del servicio</li>
              <li>Incluye tu nombre completo en el concepto de pago</li>
              <li>Guarda el comprobante de transferencia</li>
              <li>Sube el comprobante en la secci√≥n de pagos</li>
              <li>La verificaci√≥n puede tomar hasta 24 horas</li>
            </ul>
          </div>

          <div class="modal-actions">
            <button class="copy-details-btn" (click)="copyBankDetailsImproved()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              Copiar Datos
            </button>
            <button class="close-modal-btn" (click)="showBankDetailsModal = false">
              Cerrar
            </button>
          </div>
          </div>
        </div>
      </div>
      <!-- Vista Informaci√≥n del Cliente -->
      <div *ngIf="currentView === 'client-info'" class="client-info-view">
        <div class="content-header">
          <h2>Informaci√≥n del Cliente</h2>
          <p>Gestiona tu informaci√≥n personal y documentos de verificaci√≥n</p>
        </div>

        <!-- Indicador de carga -->
        <div *ngIf="isLoadingClientData" class="loading-container">
          <div class="loading-spinner"></div>
          <p>Cargando informaci√≥n del cliente...</p>
        </div>

        <div class="client-info-container" *ngIf="!isLoadingClientData">
          <!-- Estado de verificaci√≥n -->
          <div class="verification-status-card" *ngIf="clientData">
            <div class="status-header">
              <h3>Estado de Verificaci√≥n</h3>
              <div class="status-badge" [ngClass]="{
                'verified': clientData.verification_status === 'verified',
                'pending': clientData.verification_status === 'pending',
                'rejected': clientData.verification_status === 'rejected'
              }">
                <span class="status-dot"></span>
                <span class="status-text">
                  {{ clientData.verification_status === 'verified' ? 'Verificado' : 
                     clientData.verification_status === 'pending' ? 'En Revisi√≥n' : 
                     clientData.verification_status === 'rejected' ? 'Rechazado' : 'Sin Verificar' }}
                </span>
              </div>
            </div>
            <p class="status-description" *ngIf="clientData.verification_date">
              Verificado el {{ clientData.verification_date | date: 'dd/MM/yyyy' }}
            </p>
          </div>

          <!-- Formulario de informaci√≥n del cliente -->
          <div class="client-info-form-card">
            <form #clientInfoForm="ngForm" (ngSubmit)="saveClientInfoData()">
              
              <!-- Secci√≥n: Contacto de Emergencia -->
              <div class="form-section">
                <h3 class="section-title">Contacto de Emergencia</h3>
                <div class="form-row">
                  <div class="form-group">
                    <label for="emergency-contact-name">Nombre Completo *</label>
                    <input 
                      type="text" 
                      id="emergency-contact-name"
                      name="emergency_contact_name"
                      [(ngModel)]="clientData.emergency_contact_name"
                      required
                      minlength="2"
                      maxlength="100"
                      pattern="^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$"
                      placeholder="Nombre del contacto de emergencia"
                      class="form-input">
                    <span class="form-hint">Solo letras y espacios (2-100 caracteres)</span>
                  </div>
                  <div class="form-group">
                    <label for="emergency-contact-phone">Tel√©fono *</label>
                    <input 
                      type="tel" 
                      id="emergency-contact-phone"
                      name="emergency_contact_phone"
                      [(ngModel)]="clientData.emergency_contact_phone"
                      required
                      minlength="10"
                      maxlength="15"
                      pattern="^\d{10,15}$"
                      placeholder="1234567890"
                      class="form-input">
                    <span class="form-hint">Solo n√∫meros (10-15 d√≠gitos)</span>
                  </div>
                </div>
              </div>

              <!-- Secci√≥n: Informaci√≥n Familiar -->
              <div class="form-section">
                <h3 class="section-title">Informaci√≥n Familiar</h3>
                <div class="form-row">
                  <div class="form-group">
                    <label for="number-of-children">N√∫mero de Ni√±os *</label>
                    <input 
                      type="number" 
                      id="number-of-children"
                      name="number_of_children"
                      [(ngModel)]="clientData.number_of_children"
                      required
                      min="0"
                      max="20"
                      placeholder="0"
                      class="form-input">
                    <span class="form-hint">Cantidad de ni√±os que requieren cuidado (0-20)</span>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group full-width">
                    <label for="special-requirements">Requisitos Especiales</label>
                    <textarea 
                      id="special-requirements"
                      name="special_requirements"
                      [(ngModel)]="clientData.special_requirements"
                      maxlength="500"
                      rows="4"
                      placeholder="Alergias, necesidades especiales, instrucciones m√©dicas, etc."
                      class="form-textarea"></textarea>
                    <span class="form-hint">Describe cualquier necesidad especial o consideraci√≥n importante (m√°x. 500 caracteres)</span>
                  </div>
                </div>
              </div>

              <!-- Secci√≥n: Documento de Identificaci√≥n -->
              <div class="form-section">
                <h3 class="section-title">Documento de Identificaci√≥n</h3>
                
                <!-- Preview del archivo seleccionado (nuevo archivo) -->
                <div class="file-upload-preview" *ngIf="identificationPreviewUrl">
                  <div class="preview-header">
                    <h4>Vista previa del documento seleccionado:</h4>
                    <button type="button" class="clear-preview-btn" (click)="clearIdentificationPreview()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/>
                        <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/>
                      </svg>
                    </button>
                  </div>
                  
                  <!-- Preview de imagen -->
                  <div class="document-image-preview" *ngIf="identificationPreviewType === 'image'">
                    <img [src]="identificationPreviewUrl" alt="Vista previa del documento" class="preview-image">
                  </div>
                  
                  <!-- Preview de PDF -->
                  <div class="document-pdf-preview" *ngIf="identificationPreviewType === 'pdf'">
                    <div class="pdf-icon">
                      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" stroke="#e11d48" stroke-width="2" fill="#fef2f2"/>
                        <polyline points="13,2 13,9 20,9" stroke="#e11d48" stroke-width="2"/>
                        <text x="12" y="16" text-anchor="middle" font-size="8" fill="#e11d48">PDF</text>
                      </svg>
                    </div>
                    <p class="pdf-name">{{ identificationDocumentFile?.name }}</p>
                    <a [href]="identificationPreviewUrl" target="_blank" class="view-pdf-btn">
                      Ver PDF completo
                    </a>
                  </div>
                </div>

                <!-- Documento ya guardado en el servidor -->
                <div class="file-upload-preview" *ngIf="clientData.identification_document && !identificationPreviewUrl">
                  <div class="preview-header">
                    <h4>Documento guardado:</h4>
                  </div>
                  
                  <!-- Vista previa si es una imagen -->
                  <div class="document-image-preview" *ngIf="isIdentificationImage()">
                    <img [src]="getIdentificationDocumentUrl()" alt="Documento de identificaci√≥n" class="preview-image">
                  </div>
                  
                  <!-- Informaci√≥n del archivo PDF guardado -->
                  <div class="document-pdf-preview" *ngIf="isIdentificationPDF()">
                    <div class="pdf-icon">
                      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" stroke="#e11d48" stroke-width="2" fill="#fef2f2"/>
                        <polyline points="13,2 13,9 20,9" stroke="#e11d48" stroke-width="2"/>
                        <text x="12" y="16" text-anchor="middle" font-size="8" fill="#e11d48">PDF</text>
                      </svg>
                    </div>
                    <p class="pdf-name">{{ clientData.identification_document }}</p>
                    <a [href]="getIdentificationDocumentUrl()" target="_blank" class="view-pdf-btn">
                      Ver PDF completo
                    </a>
                  </div>
                </div>
                
                <!-- Input para subir archivo -->
                <div class="file-upload-input">
                  <input 
                    type="file" 
                    id="identification-document"
                    (change)="onIdentificationUpload($event)"
                    accept=".pdf,.jpg,.jpeg,.png,.gif"
                    class="file-input-hidden">
                  <label for="identification-document" class="file-input-label">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2"/>
                      <polyline points="17,8 12,3 7,8" stroke="currentColor" stroke-width="2"/>
                      <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span>{{ (clientData.identification_document || identificationPreviewUrl) ? 'Cambiar documento' : 'Subir documento' }}</span>
                  </label>
                  <span class="form-hint">PDF o imagen (JPG, PNG) - M√°ximo 10MB</span>
                </div>
              </div>

              <!-- Mensajes de error -->
              <div class="error-messages" *ngIf="clientInfoErrorMessage">
                <div class="error-alert">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="16" x2="12.01" y2="16" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <span>{{ clientInfoErrorMessage }}</span>
                </div>
              </div>

              <!-- Mensajes de √©xito -->
              <div class="success-messages" *ngIf="clientInfoSuccessMessage">
                <div class="success-alert">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2"/>
                    <polyline points="22,4 12,14.01 9,11.01" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <span>{{ clientInfoSuccessMessage }}</span>
                </div>
              </div>

              <!-- Botones de acci√≥n -->
              <div class="form-actions">
                <button 
                  type="submit" 
                  class="btn-primary"
                  [disabled]="isSavingClientData || !clientInfoForm.valid">
                  <span *ngIf="!isSavingClientData">Guardar Informaci√≥n</span>
                  <span *ngIf="isSavingClientData">
                    <svg class="spinner" width="20" height="20" viewBox="0 0 24 24">
                      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                    Guardando...
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Vista de Notificaciones -->
      <div *ngIf="currentView === 'notifications'" class="notifications-view">
        <div class="content-header">
          <h2>üì¨ Mis Notificaciones</h2>
          <p>Revisa todas tus notificaciones y acciones pendientes</p>
        </div>

        <div class="notifications-container">
          <app-notifications-panel
            title="Notificaciones"
            [showHeader]="false"
            [showFilters]="true"
            (notificationClicked)="handleNotificationPanelClick($event)">
          </app-notifications-panel>
        </div>
      </div>

    </main>
  </div>

  <!-- Modal de servicio -->
  <div class="modal-overlay" *ngIf="showServiceModal" (click)="closeServiceModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <!-- Loading State -->
      <div *ngIf="serviceModalType === 'loading'" class="modal-loading">
        <div class="spinner"></div>
        <h3>{{ serviceModalTitle }}</h3>
        <p>{{ serviceModalMessage }}</p>
      </div>

      <!-- Success State -->
      <div *ngIf="serviceModalType === 'success'" class="modal-success">
        <div class="success-icon">‚úì</div>
        <h3>{{ serviceModalTitle }}</h3>
        <p>{{ serviceModalMessage }}</p>
        <button class="modal-btn-confirm" (click)="closeServiceModal()">Entendido</button>
      </div>

      <!-- Error State -->
      <div *ngIf="serviceModalType === 'error'" class="modal-error">
        <div class="error-icon">‚úï</div>
        <h3>{{ serviceModalTitle }}</h3>
        <p>{{ serviceModalMessage }}</p>
        <div *ngIf="serviceModalErrors.length > 0" class="error-list">
          <ul>
            <li *ngFor="let error of serviceModalErrors">{{ error }}</li>
          </ul>
        </div>
        <button class="modal-btn-close" (click)="closeServiceModal()">Cerrar</button>
      </div>

      <!-- Warning State -->
      <div *ngIf="serviceModalType === 'warning'" class="modal-warning">
        <div class="warning-icon">‚ö†</div>
        <h3>{{ serviceModalTitle }}</h3>
        <p>{{ serviceModalMessage }}</p>
        <div *ngIf="serviceModalErrors.length > 0" class="error-list">
          <ul>
            <li *ngFor="let error of serviceModalErrors">{{ error }}</li>
          </ul>
        </div>
        <button class="modal-btn-close" (click)="closeServiceModal()">Entendido</button>
      </div>
    </div>
  </div>

  <!-- Modal de perfil de ni√±era -->
  <div class="nanny-profile-modal" *ngIf="showNannyProfileModal$ | async as nanny" (click)="closeNannyProfileModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="modal-header">
        <button class="close-btn" (click)="closeNannyProfileModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <h2>Perfil de Ni√±era</h2>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <!-- Avatar y Info b√°sica -->
        <div class="profile-header">
          <div class="profile-avatar">
            <img [src]="nanny.profile_image || 'assets/logo.png'" 
                 [alt]="nanny.name" 
                 (error)="$event.target.src='assets/logo.png'">
          </div>
          <div class="profile-info">
            <h3>{{ nanny.name }}</h3>
            <div class="profile-rating" *ngIf="nanny.rating">
              <div class="stars">
                <svg *ngFor="let star of [1,2,3,4,5]" 
                     [class.filled]="star <= nanny.rating"
                     width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2L13.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
                </svg>
              </div>
              <span>{{ nanny.rating }}/5 ({{ nanny.reviews_count || 0 }} calificaciones)</span>
            </div>
            <div *ngIf="!nanny.rating" class="profile-rating">
              <span class="no-rating">Sin calificaciones a√∫n</span>
            </div>
          </div>
        </div>

        <!-- Datos de contacto -->
        <div class="profile-section">
          <h4>Informaci√≥n de Contacto</h4>
          <div class="contact-info">
            <div class="info-item" *ngIf="nanny.email">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="4" width="20" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                <path d="M2 6l10 8 10-8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span>{{ nanny.email }}</span>
            </div>
            <div class="info-item">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span *ngIf="nanny.phone_number || nanny.phone">{{ nanny.phone_number || nanny.phone }}</span>
              <span *ngIf="!nanny.phone_number && !nanny.phone" class="no-data">No disponible</span>
            </div>
          </div>
        </div>

        <!-- Especialidades -->
        <div class="profile-section" *ngIf="nanny.specialties && nanny.specialties.length > 0">
          <h4>Especialidades</h4>
          <div class="specialties">
            <span *ngFor="let specialty of nanny.specialties" class="specialty-tag">{{ specialty }}</span>
          </div>
        </div>

        <!-- Descripci√≥n -->
        <div class="profile-section" *ngIf="nanny.bio">
          <h4>Acerca de</h4>
          <p>{{ nanny.bio }}</p>
        </div>

        <!-- Experiencia -->
        <div class="profile-section" *ngIf="nanny.experience">
          <h4>Experiencia</h4>
          <p>{{ nanny.experience }}</p>
        </div>
      </div>

      <!-- Footer con bot√≥n de contacto -->
      <div class="modal-footer">
        <app-whatsapp-button 
          [phoneNumber]="nanny.phone_number || nanny.phone || ''"
          [message]="'Hola ' + nanny.name + ', v√≠ tu perfil en NannysLM y me gustar√≠a contactarte para hablar sobre los servicios de cuidado infantil.'"
          [buttonText]="'Contactar por WhatsApp'">
        </app-whatsapp-button>
      </div>
    </div>
  </div>

  <!-- Modal de logout reutilizable -->
  <app-logout-modal 
    [isVisible]="showLogoutModal"
    [userName]="currentUser.name"
    [userRole]="currentUser.role"
    [redirectRoute]="'/'"
    (onCancel)="closeLogoutModal()"
    (onConfirm)="confirmLogout()">
  </app-logout-modal>

  <!-- Input de archivo oculto para comprobante de pago -->
  <input #receiptUpload
         type="file"
         id="receiptUpload"
         accept=".jpg,.jpeg,.png,.gif,.pdf"
         style="display:none"
         (change)="onReceiptSelected($event)"
         aria-label="Seleccionar comprobante de pago">
</div>